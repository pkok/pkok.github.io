---
layout: post
categories:
  - thesis
---

Derivatives of some functions I need to use:

Vector norm:

$$
\begin{align}
\frac{\partial}{\partial \mathbf{v}} \|\mathbf{v}\|
  &= \frac{\mathbf{v}}{\|\mathbf{v}\|}
\end{align}
$$

Quaternion exponential[^qexp]:

$$
\begin{align}
\frac{\partial \exp}{\partial \mathbf{v}}(\mathbf{v}) 
  &= \frac{\partial}{\partial \mathbf{v}} \begin{bmatrix} \cos \|\mathbf{v}\| \\ 
                                                          \frac{\mathbf{v}}{\|\mathbf{v}\|} \sin \|\mathbf{v}\| 
                                          \end{bmatrix} \\
  &= \frac{\partial}{\partial \mathbf{v}} \left( \cos \|\mathbf{v}\| + \frac{\mathbf{v}}{\|\mathbf{v}\|} \sin \|\mathbf{v}\| \right) \\
  &= \frac{2}{\|\mathbf{v}\|} \sin \|\mathbf{v}\| + \cos \|\mathbf{v}\| \\
  &= \begin{bmatrix} \cos \|\mathbf{v}\| \\ 
                     \frac{\mathbf{2}}{\|\mathbf{v}\|} \sin \|\mathbf{v}\| 
     \end{bmatrix}
\end{align}
$$

Quaternion product:

$$
\begin{align}
\mathbf{p} \odot \mathbf{q}
  &= \phantom{+} (q_0 p_0 - q_1 p_1 - q_2 p_2 - q_3 p_3)            \\
  &\phantom{=} + (q_0 p_1 + q_1 p_0 - q_2 p_3 + q_3 p_2) \mathbf{i} \\
  &\phantom{=} + (q_0 p_2 + q_1 p_3 + q_2 p_0 - q_3 p_1) \mathbf{j} \\
  &\phantom{=} + (q_0 p_3 - q_1 p_2 + q_2 p_1 + q_3 p_0) \mathbf{k} \\
\frac{\partial}{\partial \mathbf{p}} (\mathbf{p} \odot \mathbf{q})
  &= \phantom{+} (q_0 - q_1 - q_2 - q_3)            & 
                                                    \frac{\partial}{\partial \mathbf{q}} (\mathbf{p} \odot \mathbf{q})
                                                        &= \phantom{+} (p_0 - p_1 - p_2 - p_3)            \\
  &\phantom{=} + (q_1 + q_0 + q_3 - q_2) \mathbf{i} &   &\phantom{=} + (p_1 + p_0 - p_3 + p_2) \mathbf{i} \\
  &\phantom{=} + (q_2 - q_3 + q_0 + q_1) \mathbf{j} &   &\phantom{=} + (p_2 + p_3 + p_0 - p_1) \mathbf{j} \\
  &\phantom{=} + (q_3 + q_2 - q_1 + q_0) \mathbf{k} &   &\phantom{=} + (p_3 - p_2 + p_1 + p_0) \mathbf{k} \\
  &= \phantom{+} (q_0 - q_1 - q_2 - q_3)            &   &= \phantom{+} (p_0 - p_1 - p_2 - p_3)            \\
  &\phantom{=} + (q_0 + q_1 - q_2 + q_3) \mathbf{i} &   &\phantom{=} + (p_0 + p_1 + p_2 - p_3) \mathbf{i} \\
  &\phantom{=} + (q_0 + q_1 + q_2 - q_3) \mathbf{j} &   &\phantom{=} + (p_0 - p_1 + p_2 + p_3) \mathbf{j} \\
  &\phantom{=} + (q_0 - q_1 + q_2 + q_3) \mathbf{k} &   &\phantom{=} + (p_0 + p_1 - p_2 + p_3) \mathbf{k} \\
\end{align}
$$

-----------

More specific definitions and derivatives, as used in Bleser's work.  For Model 1 (gyro):

$$
\begin{align}
f(\mathbf{x}, \mathbf{u}, ?)
  &= f \left(\begin{bmatrix} \mathbf{s}_{w,t} \\
                             \dot{\mathbf{s}}_{w,t} \\
                             \mathbf{q}_{sw,t} \\
                             \mathbf{\omega}_{s,t} \\
                             \mathbf{b}^\omega_{s,t}
             \end{bmatrix}, \mathbf{u}, ? \right) \\
  &= \begin{bmatrix} \mathbf{s}_{w,t-T} + T \dot{\mathbf{s}}_{w,t-T} + \frac{T^2}{2} \mathbf{v}^\ddot{s}_{w,t} \\
                     \dot{\mathbf{s}}_{w,t-T} + T \mathbf{v}^\ddot{s}_{w,t} \\
                     \exp\left( -\frac{T}{2} (\omega_{s,t-T} + \mathbf{v}^\omega_{s,t}) \right) \odot \mathbf{q}_{sw,t-T} \\
                     \mathbf{\omega}_{s,t-T} + \mathbf{v}^\omega_{s,t} \\
                     \mathbf{b}^\omega_{s,t-T} + \mathbf{v}^{\mathbf{b}^\omega}_{s,t}
     \end{bmatrix} \\
\frac{\partial f}{\partial \mathbf{x}}(\mathbf{x}, \mathbf{u}, ?)
  &= \begin{bmatrix} I_3 & T I_3 & 0 & 0   & 0 \\
                     0   & I_3   & 0 & 0   & 0 \\
                     0   & 0     & \frac{\partial}{\partial \mathbf{q}_{sw}}\left(\exp(\mathbf{a} \odot \mathbf{q}_{sw} \right) & -\frac{T}{2} \frac{\partial}{\partial \exp(\mathbf{a})} \left(\exp(\mathbf{a}) \odot \mathbf{q}_{sw,t-T}\right) \frac{\partial \exp}{\partial \mathbf{a}}(\mathbf{a}) & 0 \\
                     0   & 0     & 0 & I_3 & 0 \\
                     0   & 0     & 0 & 0   & I_3
     \end{bmatrix} \\
\frac{\partial f}{\partial \mathbf{v}}(\mathbf{x}, \mathbf{u}, ?)
  &= \begin{bmatrix} \frac{T^2}{2} I_3 & 0   & 0 \\
                     T I_3             & 0   & 0 \\
                     0                 & -\frac{T}{2} \frac{\partial}{\partial \exp(\mathbf{a})} \left(\exp(\mathbf{a}) \odot \mathbf{q}_{sw,t-T}\right) \frac{\partial \exp}{\partial \mathbf{a}}(\mathbf{a}) & 0 \\
                     0                 & I_3 & 0 \\
                     0                 & 0   & I_3
     \end{bmatrix} \\
  &\phantom{=}\mbox{ with } \mathbf{v}^T = \begin{bmatrix}\mathbf{v}^\ddot{s}_{w,t} & \mathbf{v}^\omega_{s,t} & \mathbf{v}^{\mathbf{b}^\omega}_{s,t} \end{bmatrix}, \\
  &\phantom{= \mbox{ with }}\mathbf{a} = \frac{T}{2}(\mathbf{\omega}_{s,t-T} + \mathbf{v}^\omega_{s,t})
\end{align}
$$

$$
\begin{align}
h(\mathbf{x}_t, \mathbf{m}_{n,t}, \mathbf{m}_{w,t}, \mathbf{e}^c_t)
  &= \begin{bmatrix} I_2 & -\mathbf{m}_{n,t} \end{bmatrix} Q_{cs} \left( Q_{sw,t} \left(\mathbf{m}_{w,t} - \mathbf{s}_{w,t} \right) - \mathbf{c}_s \right) + \mathbf{e}^c_t \\
\frac{\partial{h}}{\partial \mathbf{x}}(\mathbf{x}_t, \mathbf{m}_{n,t}, \mathbf{m}_{w,t}, \mathbf{e}^c_t)
  &= -3 \begin{bmatrix} I_2 & -\mathbf{m}_{n,t} \end{bmatrix} Q_{cs} Q_{sw} \\
\frac{\partial{h}}{\partial \mathbf{e}}(\mathbf{x}_t, \mathbf{m}_{n,t}, \mathbf{m}_{w,t}, \mathbf{e}^c_t)
  &= 2 \\
\frac{\partial{h}}{\partial \mathbf{m}_{n,t}}(\mathbf{x}_t, \mathbf{m}_{n,t}, \mathbf{m}_{w,t}, \mathbf{e}^c_t)
  &= 2 Q_{cs} \left( Q_{sw,t} \left( \mathbf{m}_{w,t} - \mathbf{s}_{w,t} \right) - \mathbf{c}_s \right) \\
\frac{\partial{h}}{\partial \mathbf{m}_{w,t}}(\mathbf{x}_t, \mathbf{m}_{n,t}, \mathbf{m}_{w,t}, \mathbf{e}^c_t)
  &= 3 \begin{bmatrix} I_2 & -\mathbf{m}_{n,t} \end{bmatrix} Q_{cs} Q_{sw} \\
\end{align}
$$

[^qexp]: The trick here is to keep your values on the right basis; if you "blindly" differentiate the composed-vector-notation-version, you would get $$\begin{bmatrix}\frac{2}{\|\mathbf{v}\|} \sin \|\mathbf{v}\| \\ \cos \|\mathbf{v}\| \end{bmatrix}$$.
